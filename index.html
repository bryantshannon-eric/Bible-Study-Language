<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bible Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .verse-window {
      height: 100%;
      display: flex;
      flex-direction: column;
      background-color: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: all 0.3s ease-in-out;
    }
    .verse-content {
      padding: 1.5rem;
      line-height: 2;
      flex-grow: 1;
      overflow-y: auto;
    }
    .fullscreen {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 50;
    }
    .settings-panel {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 60;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }
    .settings-panel.active {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body class="p-8">

  <!-- Header -->
  <header class="bg-white rounded-2xl shadow-lg p-6 mb-8 flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
    <h1 class="text-3xl font-bold text-gray-800">Bible Viewer</h1>
    <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
      <select id="bookSelect" class="bg-gray-100 rounded-lg p-2.5"></select>
      <input type="number" id="chapterInput" min="1" value="1" class="w-24 bg-gray-100 rounded-lg p-2.5 text-center"/>
      <input type="number" id="verseInput" min="1" value="1" class="w-24 bg-gray-100 rounded-lg p-2.5 text-center"/>
      <button id="showSettingsBtn" class="bg-blue-500 text-white rounded-lg px-6 py-2.5 font-semibold hover:bg-blue-600">Settings</button>
    </div>
  </header>

  <!-- Main windows -->
  <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-screen-32">
    <div id="window-1" class="verse-window">
      <div class="p-4 bg-blue-100 text-blue-800 font-semibold flex justify-between">
        <span id="version-title-1"></span>
        <button class="fullscreen-btn">â›¶</button>
      </div>
      <div id="verse-content-1" class="verse-content"></div>
    </div>
    <div id="window-2" class="verse-window">
      <div class="p-4 bg-blue-100 text-blue-800 font-semibold flex justify-between">
        <span id="version-title-2"></span>
        <button class="fullscreen-btn">â›¶</button>
      </div>
      <div id="verse-content-2" class="verse-content"></div>
    </div>
    <div id="window-3" class="verse-window">
      <div class="p-4 bg-blue-100 text-blue-800 font-semibold flex justify-between">
        <span id="version-title-3"></span>
        <button class="fullscreen-btn">â›¶</button>
      </div>
      <div id="verse-content-3" class="verse-content"></div>
    </div>
    <div id="window-4" class="verse-window">
      <div class="p-4 bg-blue-100 text-blue-800 font-semibold flex justify-between">
        <span id="version-title-4"></span>
        <button class="fullscreen-btn">â›¶</button>
      </div>
      <div id="verse-content-4" class="verse-content"></div>
    </div>
  </main>

  <!-- Settings -->
  <div id="settingsPanel" class="settings-panel">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-11/12 md:w-1/2 lg:w-1/3 space-y-6">
      <h2 class="text-2xl font-bold">Settings</h2>
      <div class="space-y-4">
        <div><label>Window 1: <select id="versionSelect-1"></select></label></div>
        <div><label>Window 2: <select id="versionSelect-2"></select></label></div>
        <div><label>Window 3: <select id="versionSelect-3"></select></label></div>
        <div><label>Window 4: <select id="versionSelect-4"></select></label></div>
      </div>
      <div class="flex justify-end space-x-4">
        <button id="closeSettingsBtn" class="bg-gray-300 px-6 py-2.5 rounded-lg">Close</button>
        <button id="saveSettingsBtn" class="bg-green-500 text-white px-6 py-2.5 rounded-lg">Save</button>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    let bibleData;
    const windowCount = 4;
    let userSettings = {
      versions: [],
      currentBook: "Genesis",
      currentChapter: 1,
      currentVerse: 1
    };

    const bookSelect = document.getElementById('bookSelect');
    const chapterInput = document.getElementById('chapterInput');
    const verseInput = document.getElementById('verseInput');
    const showSettingsBtn = document.getElementById('showSettingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const fullscreenBtns = document.querySelectorAll('.fullscreen-btn');

    async function loadBibleData() {
  const fileNames = {
    "ESV": { file: "ESV.json", name: "English Standard Version" },
    "GNT": { file: "GNT.json", name: "Greek New Testament" },
    "KJV": { file: "KJV.json", name: "King James Version" },
    "RVR": { file: "RVR.json", name: "Reina Valera 1909" }
  };
  const result = {};
  await Promise.all(Object.entries(fileNames).map(([key, fileInfo]) =>
    fetch(fileInfo.file)
      .then(r => r.json())
      .then(data => {
        const rootKey = Object.keys(data)[0];
        const rootData = data[rootKey];

        let books = rootData.books || data;

        // ðŸ”‘ Normalize Spanish book names so they match English lookups
        if (key === "RVR") {
          const normalizedBooks = {};
          for (const [bookName, chapters] of Object.entries(books)) {
            // Strip accents â†’ e.g., GÃ©nesis â†’ Genesis, Ã‰xodo â†’ Exodo
            const normalized = bookName.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            normalizedBooks[normalized] = chapters;
          }
          books = normalizedBooks;
        }

        result[key] = {
          name: rootData.name || fileInfo.name,
          books
        };
      })
  ));
  return result;
}


    function updateVerseDisplays() {
      for (let i = 1; i <= windowCount; i++) {
        const versionKey = userSettings.versions[i - 1];
        const versionTitleEl = document.getElementById(`version-title-${i}`);
        const verseContentEl = document.getElementById(`verse-content-${i}`);
        const book = userSettings.currentBook;
        let verseText = "Not found";

        if (bibleData[versionKey]?.books[book]?.[userSettings.currentChapter]) {
          verseText = bibleData[versionKey].books[book][userSettings.currentChapter][userSettings.currentVerse] || "Not found";
        }

        versionTitleEl.textContent = `${bibleData[versionKey].name} - ${book} ${userSettings.currentChapter}:${userSettings.currentVerse}`;
        verseContentEl.textContent = verseText;
      }
    }

    function populateBookSelect() {
      const firstVersionKey = Object.keys(bibleData)[0];
      const bookNames = Object.keys(bibleData[firstVersionKey].books);
      bookSelect.innerHTML = bookNames.map(b => `<option>${b}</option>`).join('');
      if (!bookNames.includes(userSettings.currentBook)) {
        userSettings.currentBook = bookNames[0];
      }
      bookSelect.value = userSettings.currentBook;
    }

    function handleSelectionChange() {
      userSettings.currentBook = bookSelect.value;
      userSettings.currentChapter = +chapterInput.value;
      userSettings.currentVerse = +verseInput.value;
      updateVerseDisplays();
    }

    function toggleSettingsPanel(show) {
      settingsPanel.classList.toggle('active', show);
    }

    function saveSettings() {
      for (let i = 1; i <= windowCount; i++) {
        userSettings.versions[i - 1] = document.getElementById(`versionSelect-${i}`).value;
      }
      localStorage.setItem('bibleSettings', JSON.stringify(userSettings));
      updateVerseDisplays();
      toggleSettingsPanel(false);
    }

    function toggleFullscreen(e) {
      const win = e.target.closest('.verse-window');
      const isFs = win.classList.toggle('fullscreen');
      document.querySelector('header').classList.toggle('hidden', isFs);
      document.querySelector('main').classList.toggle('block', isFs);
      document.querySelector('main').classList.toggle('grid', !isFs);
      document.querySelectorAll('.verse-window').forEach(w => {
        if (w !== win) w.style.display = isFs ? 'none' : 'flex';
      });
    }

    bookSelect.addEventListener('change', handleSelectionChange);
    chapterInput.addEventListener('change', handleSelectionChange);
    verseInput.addEventListener('change', handleSelectionChange);
    showSettingsBtn.addEventListener('click', () => toggleSettingsPanel(true));
    closeSettingsBtn.addEventListener('click', () => toggleSettingsPanel(false));
    saveSettingsBtn.addEventListener('click', saveSettings);
    fullscreenBtns.forEach(btn => btn.addEventListener('click', toggleFullscreen));

    async function initializeApp() {
      bibleData = await loadBibleData();
      const saved = localStorage.getItem('bibleSettings');
      if (saved) {
        userSettings = JSON.parse(saved);
      } else {
        const keys = Object.keys(bibleData);
        userSettings.versions = keys.slice(0, windowCount);
        userSettings.currentBook = Object.keys(bibleData[keys[0]].books)[0];
      }
      populateBookSelect();
      const keys = Object.keys(bibleData);
      for (let i = 1; i <= windowCount; i++) {
        const sel = document.getElementById(`versionSelect-${i}`);
        sel.innerHTML = keys.map(k => `<option value="${k}">${bibleData[k].name}</option>`).join('');
        sel.value = userSettings.versions[i - 1];
      }
      chapterInput.value = userSettings.currentChapter;
      verseInput.value = userSettings.currentVerse;
      bookSelect.value = userSettings.currentBook;
      updateVerseDisplays();
    }

    initializeApp();
  </script>
</body>
</html>

